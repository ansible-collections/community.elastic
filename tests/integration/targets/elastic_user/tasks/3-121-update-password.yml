---
- vars:
    elastic_user_parameters: &elastic_user_parameters
      login_user: elastic
      login_password: secret
      auth_method: http_auth
      timeout: 30

  block:

  - name: Create a user
    community.elastic.elastic_user:
      name: rhys-update-password
      password: secret
      full_name: "Rhys Campbell"
      email: email@email.com
      state: present
      roles:
        - "role1"
        - "role2"
      <<: *elastic_user_parameters
    register: elastic

  - assert:
      that:
        - "elastic.changed == True"
        - "'The user rhys was successfully created' in elastic.msg"

  # should change because update_password default = always
  - name: Create a user again
    community.elastic.elastic_user:
      name: rhys-update-password
      password: secret
      full_name: "Rhys Campbell"
      email: email@email.com
      state: present
      roles:
        - "role1"
        - "role2"
      <<: *elastic_user_parameters
    register: elastic

  - assert:
      that:
        - "elastic.changed == True"
        - "'The user rhys was successfully created' in elastic.msg"

  # Passowrd should not be updated here
  - name: Create a user again - no change
    community.elastic.elastic_user:
      name: rhys-update-password
      password: secret
      full_name: "Rhys Campbell"
      email: email@email.com
      state: present
      update_password: "on_create"
      roles:
        - "role1"
        - "role2"
      <<: *elastic_user_parameters
    register: elastic

  - assert:
      that:
        - "elastic.changed == True"
        - "'The user rhys was successfully created' in elastic.msg"