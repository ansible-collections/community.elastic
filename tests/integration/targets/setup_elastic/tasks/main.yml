---
- name: Ensure required python moules are installed
  pip:
    name: "{{ item }}"
  with_items:
    - docker
    - six

- name: Update and upgrade apt packages
  become: true
  apt:
    upgrade: yes
    update_cache: yes

- name: Install required packages for APT over HTTPS
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true
  become: true

- name: Add Docker's official GPG key
  ansible.builtin.shell: |
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

- name: Add Docker APT repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release | lower }} stable"
    filename: docker
    state: present
  become: true

- name: Update apt and install Docker and Compose V2
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true
  become: true

- name: Unmask docker and start service
  shell: |
    sudo systemctl unmask docker
    sudo systemctl start docker || systemctl status docker.service

# https://forums.docker.com/t/failed-to-start-docker-service-unit-is-masked/67413/2
#- name: Ensure docker is started
#  service:
#    name: docker
#    state: started
#  become: true

- name: Ensure any existing docker containers are removed
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
  with_items: "{{ docker_containers }}"

- name: Clean up docker volumes
  community.docker.docker_volume:
    name: "{{ item }}"
    state: absent
  with_items: "{{ docker_volumes }}"

- name: Run docker compose file
  shell: docker compose -f {{ docker_compose_file | default('single-node-elastic.yml') }} up --detach
  args:
    chdir: "{{role_path}}/docker"
  environment:
    ELASTICSEARCH_VERSION: "{{ elasticsearch_version }}"
    KIBANA_VERSION: "{{ kibana_version }}"
  notify: Clean up docker containers and volumes

- name: Set elastic_ports to 9200 when using a single node
  set_fact:
    elastic_ports:
      - 9200
  when: docker_compose_file is undefined or "'single-node' in docker_compose_file"

- name: Wait for ports to become available
  wait_for:
    port: "{{ item }}"
    delay: 3
  with_items: "{{ elastic_ports }}"

- name: Wait for Elastic to come up
  uri:
    url: "http://127.0.0.1:9200"
    method: GET
    return_content: yes
    status_code:
      - 200
      - 401
  register: _result
  until: '"You Know, for Search" in _result.content or "missing authentication credentials for REST request" in _result.content'
  retries: 30 # retry X times
  delay: 3 # pause for X sec b/w each call
